<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>cloudkitchen.dyg++ | Pemesanan Online</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { 
            --primary: #1B4332; --accent: #F39C12; --bg: #F8FBF8; 
            --surface: #FFFFFF; --text: #2D3436; --muted: #636E72;
            --soft: #F0F0F0; --danger: #D63031; --success: #00B894;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; background: var(--bg); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; color: var(--text); 
            overflow-x: hidden;
        }

        /* OVERLAY AWAL */
        #welcome-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: var(--primary); color: white; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; padding: 20px;
        }
        .btn-start {
            background: var(--accent); color: white; border: none;
            padding: 15px 40px; border-radius: 30px; font-weight: 800;
            font-size: 16px; margin-top: 20px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* HEADER & UI COMPONENTS */
        .header-top { 
            background: var(--primary); padding: 20px; color: white;
            border-bottom-left-radius: 25px; border-bottom-right-radius: 25px;
        }
        .mode-selector {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .btn-mode {
            flex: 1; padding: 12px; border-radius: 12px; border: 1.5px solid rgba(255,255,255,0.3);
            background: transparent; color: white; font-weight: 600; font-size: 13px;
            transition: 0.3s; position: relative;
        }
        .btn-mode.active { background: white; color: var(--primary); border-color: white; }
        .badge-status {
            position: absolute; top: -8px; right: -5px; background: var(--accent);
            color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px;
            opacity: 0; transition: 0.3s;
        }

        /* BANNER */
        .banner-container { padding: 15px; overflow-x: auto; display: flex; gap: 12px; scrollbar-width: none; }
        .banner-container::-webkit-scrollbar { display: none; }
        .banner-card { 
            min-width: 280px; height: 140px; background: #eee; border-radius: 15px;
            background-size: cover; background-position: center; flex-shrink: 0;
        }

        /* MENU LIST */
        .menu-section { padding: 0 15px 120px 15px; }
        .menu-card {
            background: white; border-radius: 16px; padding: 12px; margin-bottom: 12px;
            display: flex; gap: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid #f0f0f0;
        }
        .menu-img { width: 90px; height: 90px; border-radius: 12px; object-fit: cover; background: #f9f9f9; }
        .menu-info { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .menu-name { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
        .menu-price { font-weight: 800; color: var(--primary); font-size: 14px; }
        
        .variant-box { margin-top: 8px; display: flex; flex-direction: column; gap: 5px; }
        select {
            width: 100%; padding: 6px; border-radius: 8px; border: 1px solid #ddd;
            font-size: 12px; background: #fff;
        }

        .qty-ctrl { display: flex; align-items: center; gap: 12px; margin-top: 10px; justify-content: flex-end; }
        .btn-qty { 
            width: 28px; height: 28px; border-radius: 8px; border: 1.5px solid var(--primary);
            background: white; color: var(--primary); font-weight: 800; 
        }
        .btn-qty:disabled { border-color: #ccc; color: #ccc; }

        /* BOTTOM NAV */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white;
            padding: 15px; border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.1); z-index: 1000;
        }
        .price-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .btn-order {
            width: 100%; background: var(--primary); color: white; border: none;
            padding: 15px; border-radius: 12px; font-weight: 700; font-size: 15px;
        }
        .btn-order:disabled { background: #ccc; }

        /* MAPS HIDDEN */
        #map-hidden { display: none; }

        /* MODAL */
        .modal {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 2000;
            align-items: flex-end;
        }
        .modal-content {
            background: white; width: 100%; border-top-left-radius: 20px;
            border-top-right-radius: 20px; padding: 20px; max-height: 85vh; overflow-y: auto;
        }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 5px; }
        .input-group input, .input-group textarea {
            width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd;
        }
        
        .swipe-indicator {
            width: 40px; height: 4px; background: #ddd; border-radius: 2px;
            margin: 0 auto 15px auto;
        }
    </style>
</head>
<body>

<div id="welcome-overlay">
    <h1 style="margin:0; font-weight:900;">cloudkitchen.dyg++</h1>
    <p style="opacity:0.8; font-size:14px;">Masakan Rumah Sehat & Higienis</p>
    <button class="btn-start" onclick="startApp()">MULAI SEKARANG</button>
</div>

<div class="header-top">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
            <div style="font-size:12px; opacity:0.8;">Lokasi Anda</div>
            <div id="user-addr" style="font-weight:700; font-size:14px;">Mendeteksi lokasi...</div>
        </div>
        <div style="text-align:right;">
            <div style="font-weight:900; font-size:18px;">dyg++</div>
        </div>
    </div>

    <div class="mode-selector">
        <button class="btn-mode active" id="mDine" onclick="switchMode('DINE_IN', this)">
            Dine In
            <span class="badge-status" id="dineInBadge"></span>
        </button>
        <button class="btn-mode" id="mDelivery" onclick="switchMode('DELIVERY', this)">
            Delivery
            <span class="badge-status" id="deliveryBadge"></span>
        </button>
    </div>
</div>

<div class="banner-container" id="banner-list">
    </div>

<div class="menu-section">
    <h3 style="font-weight:800; margin: 20px 0 15px 0;">Menu Spesial</h3>
    <div id="menu-container">
        </div>
</div>

<div class="bottom-nav">
    <div class="swipe-indicator" id="swipeInd" style="display:none;"></div>
    <div class="price-summary">
        <div>
            <div style="font-size:11px; color:var(--muted);">Total Pembayaran</div>
            <div style="font-weight:900; font-size:18px; color:var(--primary);">Rp <span id="miniPrice">0</span></div>
        </div>
        <div style="text-align:right;">
            <div id="dist-info" style="font-size:11px; font-weight:700; color:var(--accent); display:none;"></div>
            <div id="ongkir-label" style="font-size:11px; color:var(--success); font-weight:700; display:none;"></div>
        </div>
    </div>
    <button class="btn-order" id="btnOrder" disabled onclick="openOrderModal()">PILIH MENU</button>
</div>

<div class="modal" id="orderModal">
    <div class="modal-content">
        <div class="swipe-indicator"></div>
        <h3 style="font-weight:900; margin-top:0;">Detail Pesanan</h3>
        
        <div id="order-summary" style="background:var(--soft); padding:12px; border-radius:12px; margin-bottom:20px; font-size:13px;">
            </div>

        <div class="input-group">
            <label>NAMA PEMESAN</label>
            <input type="text" id="custName" placeholder="Masukkan nama Anda">
        </div>

        <div class="input-group" id="address-group" style="display:none;">
            <label>ALAMAT LENGKAP</label>
            <textarea id="custAddr" rows="3" placeholder="Nama jalan, nomor rumah, patokan..."></textarea>
        </div>

        <div class="input-group">
            <label>CATATAN TAMBAHAN (OPSIONAL)</label>
            <input type="text" id="custNote" placeholder="Contoh: Sambal dipisah">
        </div>

        <button class="btn-order" onclick="submitOrder()">KIRIM KE WHATSAPP</button>
        <button class="btn-mode" style="color:var(--danger); width:100%; margin-top:10px; border:none;" onclick="closeModal()">Batal</button>
    </div>
</div>

<div id="map-hidden"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CONFIG = {
    WARUNG_LOCATION: [-7.0252112, 110.4673627], // Titik Tengah Warung
    RADIUS_DINE_IN: 100, // Meter
    RADIUS_DELIVERY: 10000, // 10 KM
    WA_NUMBER: "62895360661144",
    GSHEET_URL: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQfT65VdD-z36xPqK-9P_9L-qitp9O9yPqXzS_XWJ8Y_O6p8D6G-3U5-6zL9n_o_YI6rM6P0qXzS_XW/pub?output=csv"
};

const VARIAN_NASI = [
    { n: "Nasi Putih", e: 0 },
    { n: "Nasi Uduk", e: 2000 },
    { n: "Nasi Kuning", e: 2000 }
];

let menuData = [];
let cart = [];
let currentMode = 'DINE_IN';
let userMap;

// FUNGSI ONGKIR (TIDAK BERUBAH)
function calculateOngkir(distMeter) {
    const km = distMeter / 1000;
    if (km <= 1.5) return 3000;
    if (km <= 3) return 5000;
    if (km <= 5) return 8000;
    // Diatas 5km, tambah 2rb per km
    return 8000 + (Math.ceil(km - 5) * 2000);
}

async function startApp() {
    const overlay = document.getElementById('welcome-overlay');
    
    navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
            const { latitude, longitude } = pos.coords;
            window.userLat = latitude;
            window.userLng = longitude;

            const distMeter = L.latLng(latitude, longitude).distanceTo(L.latLng(CONFIG.WARUNG_LOCATION)) * 1.45;
            window.userDist = distMeter;

            const dineBadge = document.getElementById('dineInBadge');
            const deliveryBadge = document.getElementById('deliveryBadge');

            if (distMeter > CONFIG.RADIUS_DINE_IN) {
                document.getElementById('mDine').classList.add('disabled');
                if(dineBadge) { dineBadge.innerText = "Luar Jangkauan"; dineBadge.style.opacity = 1; }
            }

            if (distMeter < CONFIG.RADIUS_DELIVERY) {
                // Konsep Anda: Jika sangat dekat, delivery mungkin tidak aktif/dialihkan
                // document.getElementById('mDelivery').classList.add('disabled');
            }

            initMap(latitude, longitude);
            initBanner();
            overlay.style.display = 'none';
            await loadMenu();
        } catch (e) {
            overlay.style.display = 'none';
            await loadMenu();
        }
    }, () => {
        alert("Akses lokasi ditolak. Fitur jarak & ongkir mungkin tidak akurat.");
        overlay.style.display = 'none';
        loadMenu();
    }, { enableHighAccuracy: true });
}

async function loadMenu() {
    try {
        const response = await fetch(CONFIG.GSHEET_URL);
        const data = await response.text();
        const rows = data.split('\n').slice(1);
        
        menuData = rows.map(row => {
            const cols = row.split(',');
            return {
                id: cols[0].trim(),
                nama: cols[1].trim(),
                harga: parseInt(cols[2]),
                img: cols[3].trim(),
                kat: cols[4].trim()
            };
        });
        renderMenu();
    } catch (e) { console.error("Gagal muat menu"); }
}

function renderMenu() {
    const container = document.getElementById('menu-container');
    container.innerHTML = menuData.map(m => {
        // Logika Pengecualian Varian (Sesuai Konsep Anda)
        const isMinuman = m.kat.toLowerCase().includes('minum');
        const isSnack = m.kat.toLowerCase().includes('snack');
        const isPengecualian = ["M01", "M02"].includes(m.id); // Contoh ID tanpa varian

        return `
        <div class="menu-card">
            <img src="${m.img}" class="menu-img">
            <div class="menu-info">
                <div>
                    <div class="menu-name">${m.nama}</div>
                    <div class="menu-price">Rp ${m.harga.toLocaleString('id-ID')}</div>
                    
                    <div class="variant-box">
                        ${(!isMinuman && !isSnack && !isPengecualian) ? `
                            <select id="n-${m.id}" onchange="resetQty('${m.id}')">
                                ${VARIAN_NASI.map(v => `<option value="${v.n}">${v.n} (+${v.e})</option>`).join('')}
                            </select>
                        ` : ''}
                        
                        ${isMinuman ? `
                            <select id="s-${m.id}" onchange="resetQty('${m.id}')">
                                <option value="Dingin / Es">Dingin / Es</option>
                                <option value="Hangat / Panas">Hangat / Panas</option>
                            </select>
                        ` : ''}
                    </div>
                </div>

                <div class="qty-ctrl">
                    <button class="btn-qty" onclick="updateCart('${m.id}', -1)" id="minus-${m.id}" disabled>-</button>
                    <span id="qty-${m.id}" style="font-weight:800;">0</span>
                    <button class="btn-qty" onclick="updateCart('${m.id}', 1)">+</button>
                </div>
            </div>
        </div>`;
    }).join('');
}

function resetQty(id) {
    // Jika varian diganti, hapus item tersebut dari cart untuk mencegah salah harga
    cart = cart.filter(c => c.id !== id);
    refreshUI();
}

function updateCart(id, change) {
    const item = menuData.find(m => m.id === id);
    if (!item) return;

    if (change > 0) {
        const nEl = document.getElementById(`n-${id}`);
        const sEl = document.getElementById(`s-${id}`);
        
        let extra = 0;
        let vNasi = nEl ? nEl.value : null;
        if (vNasi) {
            const vObj = VARIAN_NASI.find(v => v.n === vNasi);
            extra = vObj ? vObj.e : 0;
        }

        cart.push({
            ...item,
            vN: vNasi,
            vS: sEl ? sEl.value : null,
            finalPrice: item.harga + extra
        });
    } else {
        const idx = cart.findLastIndex(c => c.id === id);
        if (idx !== -1) cart.splice(idx, 1);
    }
    refreshUI();
}

function refreshUI() {
    let subtotal = 0;
    const counts = {};
    
    cart.forEach(c => {
        subtotal += c.finalPrice;
        counts[c.id] = (counts[c.id] || 0) + 1;
    });

    // Sync Angka di Menu
    menuData.forEach(m => {
        const qEl = document.getElementById(`qty-${m.id}`);
        const mBtn = document.getElementById(`minus-${m.id}`);
        if(qEl) {
            const val = counts[m.id] || 0;
            qEl.innerText = val;
            if(mBtn) mBtn.disabled = val === 0;
        }
    });

    // Update Bar Bawah
    const priceEl = document.getElementById('miniPrice');
    const distEl = document.getElementById('dist-info');
    const ongEl = document.getElementById('ongkir-label');
    const sInd = document.getElementById('swipeInd');

    if (subtotal > 0) {
        sInd.style.display = 'block';
        if (currentMode === 'DELIVERY') {
            const ongkir = calculateOngkir(window.userDist || 0);
            priceEl.innerText = (subtotal + ongkir).toLocaleString('id-ID');
            distEl.innerText = `Jarak: ${((window.userDist || 0)/1000).toFixed(1)} KM`;
            distEl.style.display = 'block';
            ongEl.innerText = `+ Ongkir Rp ${ongkir.toLocaleString('id-ID')}`;
            ongEl.style.display = 'block';
        } else {
            priceEl.innerText = subtotal.toLocaleString('id-ID');
            distEl.style.display = 'none';
            ongEl.style.display = 'none';
        }
        document.getElementById('btnOrder').disabled = false;
        document.getElementById('btnOrder').innerText = 'PESAN SEKARANG';
    } else {
        sInd.style.display = 'none';
        priceEl.innerText = "0";
        distEl.style.display = 'none';
        ongEl.style.display = 'none';
        document.getElementById('btnOrder').disabled = true;
        document.getElementById('btnOrder').innerText = 'PILIH MENU';
    }
}

function switchMode(mode, btn) {
    if (btn.classList.contains('disabled')) {
        alert("Maaf, lokasi Anda di luar jangkauan untuk mode ini.");
        return;
    }
    currentMode = mode;
    document.querySelectorAll('.btn-mode').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('address-group').style.display = mode === 'DELIVERY' ? 'block' : 'none';
    refreshUI();
}

function initBanner() {
    const banners = [
        "https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=500&q=80",
        "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=500&q=80"
    ];
    document.getElementById('banner-list').innerHTML = banners.map(b => `
        <div class="banner-card" style="background-image: url('${b}')"></div>
    `).join('');
}

function initMap(lat, lng) {
    // Hanya inisialisasi untuk reverse geocoding jika perlu
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('user-addr').innerText = data.display_name.substring(0, 35) + '...';
        });
}

function openOrderModal() {
    document.getElementById('orderModal').style.display = 'flex';
    updateOrderSummary();
}

function closeModal() {
    document.getElementById('orderModal').style.display = 'none';
}

function updateOrderSummary() {
    const summaryEl = document.getElementById('order-summary');
    let html = `<div style="margin-bottom:10px; font-weight:800; border-bottom:1px solid #ccc; padding-bottom:5px;">Mode: ${currentMode}</div>`;
    
    const items = {};
    cart.forEach(c => {
        const key = `${c.nama}-${c.vN}-${c.vS}`;
        if(!items[key]) items[key] = { n: c.nama, q: 0, p: c.finalPrice, vn: c.vN, vs: c.vS };
        items[key].q++;
    });

    for(let k in items) {
        const it = items[k];
        html += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;">
            <span>${it.q}x ${it.n} ${it.vn ? `(${it.vn})` : ''} ${it.vs ? `(${it.vs})` : ''}</span>
            <span>Rp ${(it.p * it.q).toLocaleString('id-ID')}</span>
        </div>`;
    }
    summaryEl.innerHTML = html;
}

function submitOrder() {
    const nama = document.getElementById('custName').value;
    const alamat = document.getElementById('custAddr').value;
    const catatan = document.getElementById('custNote').value;

    if(!nama) { alert("Mohon isi nama Anda"); return; }
    if(currentMode === 'DELIVERY' && !alamat) { alert("Mohon isi alamat lengkap"); return; }

    let text = `*PESANAN BARU - ${currentMode}*\n`;
    text += `Nama: ${nama}\n`;
    if(currentMode === 'DELIVERY') text += `Alamat: ${alamat}\n`;
    text += `Catatan: ${catatan || '-'}\n\n*Daftar Menu:*\n`;

    let subtotal = 0;
    const items = {};
    cart.forEach(c => {
        subtotal += c.finalPrice;
        const key = `${c.nama}-${c.vN}-${c.vS}`;
        if(!items[key]) items[key] = { n: c.nama, q: 0, vn: c.vN, vs: c.vS };
        items[key].q++;
    });

    for(let k in items) {
        const it = items[k];
        text += `- ${it.q}x ${it.n} ${it.vn ? `(${it.vn})` : ''} ${it.vs ? `(${it.vs})` : ''}\n`;
    }

    let grandTotal = subtotal;
    if(currentMode === 'DELIVERY') {
        const ongkir = calculateOngkir(window.userDist || 0);
        text += `\nSubtotal: Rp ${subtotal.toLocaleString('id-ID')}`;
        text += `\nOngkir (${((window.userDist||0)/1000).toFixed(1)}km): Rp ${ongkir.toLocaleString('id-ID')}`;
        grandTotal += ongkir;
    }

    text += `\n*TOTAL BAYAR: Rp ${grandTotal.toLocaleString('id-ID')}*`;
    text += `\n\nLokasi Presisi: https://www.google.com/maps?q=${window.userLat},${window.userLng}`;

    const url = `https://wa.me/${CONFIG.WA_NUMBER}?text=${encodeURIComponent(text)}`;
    window.open(url, '_blank');
}
</script>

</body>
</html>