<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>cloudkitchen.dyg++ | Pemesanan Online</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root { 
            --primary: #1B4332; --accent: #F39C12; --bg: #F8FBF8; 
            --surface: #FFFFFF; --text: #2D3436; --muted: #636E72;
            --soft: #F0F0F0; --danger: #D63031; --success: #00B894;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; padding: 0; background: var(--bg); 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; color: var(--text); 
            overflow-x: hidden;
        }

        .header-hero {
            background: var(--primary); color: white; padding: 40px 25px 60px;
            border-radius: 0 0 40px 40px; position: relative;
            animation: slideDown 0.8s cubic-bezier(0.2, 1, 0.3, 1);
        }

        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }

        .brand-name { font-weight: 900; font-size: 22px; letter-spacing: -1px; }
        
        .antrean-card {
            background: var(--accent); position: absolute; bottom: -25px; right: 25px;
            padding: 15px 25px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            text-align: center; color: white; transform: scale(0); animation: popIn 0.5s 0.8s forwards;
        }

        @keyframes popIn { to { transform: scale(1); } }

        .main-container { padding: 50px 20px 140px; max-width: 600px; margin: auto; }
        .section-title { font-weight: 800; font-size: 15px; margin-bottom: 15px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }

        .mode-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .mode-btn {
            background: var(--surface); border: 2px solid var(--soft); padding: 15px;
            border-radius: 20px; text-align: center; cursor: pointer; transition: 0.3s;
        }
        .mode-btn.active { border-color: var(--accent); background: #FFF9F0; transform: translateY(-3px); box-shadow: 0 8px 15px rgba(243,156,18,0.1); }
        .mode-btn span { display: block; font-size: 24px; margin-bottom: 5px; }
        .mode-btn b { font-size: 13px; font-weight: 800; }

        .input-card { background: var(--surface); padding: 18px; border-radius: 22px; margin-bottom: 15px; border: 1px solid var(--soft); transition: 0.3s; }
        .input-card:focus-within { border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        input, textarea { width: 100%; border: none; background: transparent; font-family: inherit; font-size: 14px; font-weight: 600; color: var(--text); }

        /* VOUCHER STYLES */
        .voucher-input-group { display: flex; gap: 8px; align-items: center; }
        .btn-check { background: var(--primary); color: white; border: none; padding: 10px 15px; border-radius: 12px; font-weight: 800; font-size: 11px; cursor: pointer; }
        #voucherStatus { font-size: 11px; font-weight: 700; margin-top: 8px; display: none; }

        /* POIN STYLES */
        .poin-badge {
            background: #E8F5E9; padding: 12px; border-radius: 18px; margin-top: 15px;
            border: 1px dashed var(--success); display: none; align-items: center; gap: 10px;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .menu-category { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .product-card {
            background: var(--surface); border-radius: 25px; padding: 12px;
            border: 1px solid var(--soft); position: relative; transition: 0.3s;
        }
        .product-card:active { transform: scale(0.95); }
        .product-img { width: 100%; height: 130px; border-radius: 18px; object-fit: cover; margin-bottom: 12px; }
        .product-info h4 { margin: 0; font-size: 14px; font-weight: 800; }
        .price { color: var(--primary); font-weight: 900; font-size: 15px; margin-top: 5px; }
        
        .add-btn {
            background: var(--primary); color: white; border: none; width: 35px; height: 35px;
            border-radius: 12px; position: absolute; bottom: 12px; right: 12px;
            font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(27,67,50,0.3);
        }

        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white;
            padding: 25px; border-radius: 35px 35px 0 0; box-shadow: 0 -10px 40px rgba(0,0,0,0.08);
            display: flex; justify-content: space-between; align-items: center; z-index: 1000;
        }

        #map { height: 200px; border-radius: 20px; margin: 15px 0; border: 2px solid var(--soft); display: none; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); display: none; align-items: center;
            justify-content: center; z-index: 2000; backdrop-filter: blur(5px);
        }
        .modal-card {
            background: white; width: 90%; max-width: 400px; padding: 30px;
            border-radius: 35px; text-align: center; animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .variant-tag { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: 800; margin-top: 5px; }
        .v-hot { background: #FFF0F0; color: #D63031; }
        .v-ice { background: #E1F5FE; color: #0288D1; }
    </style>
</head>
<body>

    <div class="header-hero">
        <div class="brand-name">cloudkitchen.dyg++</div>
        <p style="font-size: 12px; opacity: 0.8; margin-top: 5px; font-weight: 600;">#Freshly Cooked #Locally Sourced</p>
        <div class="antrean-card">
            <div style="font-size: 10px; font-weight: 800; opacity: 0.9;">ANTREAN</div>
            <div id="noAntrean" style="font-size: 24px; font-weight: 900;">#--</div>
        </div>
    </div>

    <div class="main-container">
        <div class="mode-selector">
            <div class="mode-btn active" id="btn-dine" onclick="setMode('DINE-IN')">
                <span>üçΩÔ∏è</span><b>DINE-IN</b>
            </div>
            <div class="mode-btn" id="btn-delivery" onclick="setMode('DELIVERY')">
                <span>üõµ</span><b>DELIVERY</b>
            </div>
        </div>

        <div class="section-title">Informasi</div>
        <div class="input-card">
            <input type="text" id="custName" placeholder="Siapa nama kamu?">
        </div>

        <div id="delivery-extra" style="display:none;">
            <div class="input-card">
                <textarea id="custAddr" rows="2" placeholder="Alamat pengiriman lengkap..."></textarea>
            </div>
            <p style="font-size: 11px; font-weight: 800; color: var(--muted); margin-bottom: 10px;">üìå Tandai lokasi di peta:</p>
            <div id="map"></div>
        </div>

        <div class="section-title">Promo & Voucher</div>
        <div class="input-card">
            <div class="voucher-input-group">
                <input type="text" id="voucherCode" placeholder="Masukkan kode voucher..." style="text-transform: uppercase;">
                <button class="btn-check" onclick="applyVoucher()">KLAIM</button>
            </div>
            <div id="voucherStatus"></div>
        </div>

        <div class="section-title">Rice & Noodles</div>
        <div class="menu-category" id="cat-main"></div>

        <div class="section-title">Fresh Drinks</div>
        <div class="menu-category" id="cat-drink"></div>

        <div id="pointInfo" class="poin-badge">
            <span style="font-size: 20px;">ü™ô</span>
            <span style="font-size: 11px; font-weight: 700; color: var(--primary);">
                Selesaikan pesanan ini & dapatkan <b id="earnedPoints">0</b> Poin!
            </span>
        </div>
    </div>

    <div class="bottom-nav">
        <div>
            <div style="font-size: 11px; font-weight: 800; color: var(--muted);">Total Bayar</div>
            <div style="font-size: 20px; font-weight: 900; color: var(--primary);">Rp <span id="miniPrice">0</span></div>
        </div>
        <button id="btnOrder" onclick="openModal()" disabled 
            style="background: var(--primary); color: white; border: none; padding: 18px 30px; border-radius: 20px; font-weight: 800; cursor: pointer;">
            KONFIRMASI
        </button>
    </div>

    <div id="modalVariant" class="modal-overlay">
        <div class="modal-card">
            <h3 id="v-title" style="margin-bottom: 20px; font-weight: 900;">Pilih Varian</h3>
            <div id="v-options" style="display: grid; gap: 10px;"></div>
            <button onclick="closeVariant()" style="margin-top: 20px; border: none; background: none; font-weight: 800; color: var(--muted);">Batal</button>
        </div>
    </div>

    <div id="modalConfirm" class="modal-overlay">
        <div class="modal-card">
            <div style="font-size: 50px; margin-bottom: 15px;">üî•</div>
            <h3 style="font-weight: 900;">Kirim Pesanan?</h3>
            <p style="font-size: 13px; color: var(--muted); margin-bottom: 25px; line-height: 1.5;">
                Pastikan pesanan dan alamat kamu sudah benar ya!
            </p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="closeModal()" style="padding: 18px; border-radius: 18px; border: 2px solid var(--soft); font-weight: 800; background: white;">Batal</button>
                <button onclick="submitOrder()" style="padding: 18px; border-radius: 18px; background: var(--primary); color: white; border: none; font-weight: 800;">Ya, Kirim!</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
    const CONFIG = {
        WEB_APP_URL: "https://script.google.com/macros/s/AKfycbzQpQvX9nIuV4lHAnW6-T0YpUoP1G_l7v-t-6kC_u6nQf7xXpU/exec",
        TOKEN: "dyg-access-v2",
        KITCHEN_LOC: [-6.9147, 107.6098]
    };

    const MENUS = [
        // RICE & MIE (Ada varian kecuali Mie Lik)
        { id: 1, cat: 'main', nama: "Nasi Goreng Gila", harga: 22000, v: 'NASI', img: "https://images.unsplash.com/photo-1512058560566-42724afbc2aa?w=400" },
        { id: 2, cat: 'main', nama: "Nasi Ayam Penyet", harga: 25000, v: 'NASI', img: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400" },
        { id: 3, cat: 'main', nama: "Mie Lik Spesial", harga: 18000, v: 'NONE', img: "https://images.unsplash.com/photo-1585032226651-759b368d7246?w=400" },
        // DRINK (Ada varian kecuali Es Teh)
        { id: 10, cat: 'drink', nama: "Kopi Susu Gula Aren", harga: 18000, v: 'SUHU', img: "https://images.unsplash.com/photo-1541167760496-162955ed8a9f?w=400" },
        { id: 11, cat: 'drink', nama: "Es Teh Manis", harga: 5000, v: 'NONE', img: "https://images.unsplash.com/photo-1556679343-c7306c1976bc?w=400" },
        { id: 12, cat: 'drink', nama: "Matcha Latte", harga: 20000, v: 'SUHU', img: "https://images.unsplash.com/photo-1515823064-d6e0c04616a7?w=400" }
    ];

    const VARIANTS = {
        'SUHU': [{n:'Panas', p:0, c:'v-hot'}, {n:'Dingin', p:2000, c:'v-ice'}],
        'NASI': [{n:'Nasi Putih', p:0}, {n:'Nasi Daun Jeruk', p:5000}],
        'MIE': [{n:'Original', p:0}, {n:'Level Pedas', p:2000}]
    };

    let cart = [];
    let currentMode = 'DINE-IN';
    let userLoc = null;
    let userDist = 0;
    let map, marker;
    
    // Var Voucher & Poin
    let discountValue = 0;
    let appliedVoucher = null;
    let pointEarned = 0;

    function init() {
        renderMenu();
        syncQueue();
    }

    function renderMenu() {
        MENUS.forEach(m => {
            const container = document.getElementById(`cat-${m.cat}`);
            container.innerHTML += `
                <div class="product-card">
                    <img src="${m.img}" class="product-img">
                    <div class="product-info">
                        <h4>${m.nama}</h4>
                        <div class="price">Rp ${m.harga.toLocaleString()}</div>
                    </div>
                    <button class="add-btn" onclick="checkVariant(${m.id})">+</button>
                </div>
            `;
        });
    }

    function checkVariant(id) {
        const item = MENUS.find(x => x.id === id);
        if (item.v === 'NONE') return addToCart(item.nama, item.harga);

        const vData = VARIANTS[item.v];
        document.getElementById('v-title').innerText = item.nama;
        const opt = document.getElementById('v-options');
        opt.innerHTML = '';
        vData.forEach(v => {
            opt.innerHTML += `<button onclick="addToCart('${item.nama} (${v.n})', ${item.harga + v.p})" 
                style="padding:15px; border-radius:15px; border:2px solid var(--soft); font-weight:800; background:white;">
                ${v.n} (+${v.p})
            </button>`;
        });
        document.getElementById('modalVariant').style.display = 'flex';
    }

    function addToCart(nama, harga) {
        cart.push({nama, harga});
        closeVariant();
        refreshUI();
    }

    async function applyVoucher() {
        const code = document.getElementById('voucherCode').value.trim().toUpperCase();
        const statusEl = document.getElementById('voucherStatus');
        const subtotal = cart.reduce((a, b) => a + b.harga, 0);

        if (!code || subtotal === 0) return;

        statusEl.style.display = 'block';
        statusEl.innerText = "‚è≥ Mengecek...";

        try {
            const r = await fetch(`${CONFIG.WEB_APP_URL}?token=${CONFIG.TOKEN}&cekVoucher=${code}`);
            const res = await r.json();

            if (res.status === "VALID") {
                if (subtotal < res.min) {
                    statusEl.style.color = 'orange';
                    statusEl.innerText = `‚ùå Min. belanja Rp ${res.min.toLocaleString()}`;
                    discountValue = 0;
                } else {
                    statusEl.style.color = 'var(--success)';
                    appliedVoucher = code;
                    discountValue = (res.tipe === "PERSEN") ? (res.nilai/100)*subtotal : res.nilai;
                    statusEl.innerText = `‚úÖ Potongan Rp ${discountValue.toLocaleString()} aktif!`;
                }
            } else {
                statusEl.style.color = 'var(--danger)';
                statusEl.innerText = "‚ùå Kode tidak valid";
                discountValue = 0;
            }
            refreshUI();
        } catch (e) {
            statusEl.innerText = "Error koneksi";
        }
    }

    function refreshUI() {
        let subtotal = cart.reduce((a, b) => a + b.harga, 0);
        let total = subtotal;

        // Ongkir (Tidak disentuh)
        if (currentMode === 'DELIVERY') {
            total += (userDist > 2) ? (Math.ceil(userDist - 2) * 2000) + 5000 : 5000;
        }

        // Hitung Poin
        pointEarned = Math.floor(subtotal / 10000);
        const pBox = document.getElementById('pointInfo');
        if (pointEarned > 0) {
            pBox.style.display = 'flex';
            document.getElementById('earnedPoints').innerText = pointEarned;
        } else {
            pBox.style.display = 'none';
        }

        // Kurangi Diskon
        total -= discountValue;
        if (total < 0) total = 0;

        document.getElementById('miniPrice').innerText = total.toLocaleString('id-ID');
        document.getElementById('btnOrder').disabled = (subtotal === 0);
    }

    // MAP & MODE LOGIC (Tetap sama)
    function setMode(m) {
        currentMode = m;
        document.getElementById('btn-dine').classList.toggle('active', m === 'DINE-IN');
        document.getElementById('btn-delivery').classList.toggle('active', m === 'DELIVERY');
        document.getElementById('delivery-extra').style.display = m === 'DELIVERY' ? 'block' : 'none';
        if (m === 'DELIVERY' && !map) initMap();
        refreshUI();
    }

    function initMap() {
        document.getElementById('map').style.display = 'block';
        map = L.map('map').setView(CONFIG.KITCHEN_LOC, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        marker = L.marker(CONFIG.KITCHEN_LOC, {draggable: true}).addTo(map);
        marker.on('moveend', (e) => {
            userLoc = e.target.getLatLng();
            userDist = map.distance(userLoc, CONFIG.KITCHEN_LOC) / 1000;
            refreshUI();
        });
    }

    async function submitOrder() {
        const name = document.getElementById('custName').value;
        if (!name) return alert("Isi nama kamu ya!");

        const orderText = cart.map(i => i.nama).join(", ");
        const finalPay = document.getElementById('miniPrice').innerText.replace(/\./g, '');
        
        const url = `${CONFIG.WEB_APP_URL}?token=${CONFIG.TOKEN}&nama=${encodeURIComponent(name)}&pesanan=${encodeURIComponent(orderText)}&mode=${currentMode}&total=${finalPay}&voucherUsed=${appliedVoucher || '-'}`;
        
        document.getElementById('btnOrder').innerText = "MENGIRIM...";
        try {
            await fetch(url, { mode: 'no-cors' });
            alert("Pesanan terkirim! Silahkan tunggu.");
            location.reload();
        } catch (e) {
            location.reload();
        }
    }

    async function syncQueue() {
        try {
            const r = await fetch(CONFIG.WEB_APP_URL + `?waitQueue=true&token=${CONFIG.TOKEN}`);
            const n = await r.text();
            if (n) document.getElementById('noAntrean').innerText = "#" + n;
        } catch(e) {}
        setTimeout(syncQueue, 30000);
    }

    function closeVariant() { document.getElementById('modalVariant').style.display = 'none'; }
    function openModal() { document.getElementById('modalConfirm').style.display = 'flex'; }
    function closeModal() { document.getElementById('modalConfirm').style.display = 'none'; }

    init();
    </script>
</body>
</html>