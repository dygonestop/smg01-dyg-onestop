<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>dyg++ POS MEMBER PAKEM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body{font-family:'Plus Jakarta Sans',sans-serif;background:#0f172a;display:flex;justify-content:center;height:100dvh;overflow:hidden}
        .pos-container{width:100%;max-width:1100px;background:#F1F5F9;display:flex;flex-direction:column}
        .main-content{display:flex;flex:1;overflow:hidden}
        .menu-side{flex:1;display:flex;flex-direction:column;background:#F8FAFC;border-right:1px solid #e2e8f0}
        .admin-side{width:360px;display:flex;flex-direction:column;background:white;border-left:2px solid #cbd5e1;height:100%}
        .scroll-area{flex:1;overflow-y:auto;padding:12px}
        .sticky-bottom{shrink:0;background:#f8fafc;border-top:4px solid #fff}
        .collapse-content{display:none}
        .swipe-handle{cursor:pointer;background:#1e293b;color:#fbbf24;text-align:center;font-size:9px;padding:10px;font-weight:800;border-radius:8px;margin-bottom:5px}
        .scroll-custom::-webkit-scrollbar{width:4px}
        .scroll-custom::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}
        .badge-qty { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 10px; padding: 2px 6px; border-radius: 99px; font-weight: 800; }
    </style>
</head>
<body>

<div class="pos-container shadow-2xl">
    <div class="bg-[#1B4332] text-white p-3 flex justify-between items-center shrink-0">
        <h1 class="text-lg font-black italic tracking-tighter text-emerald-400">dyg++ <span class="text-white opacity-50 ml-2">POS SECURE</span></h1>
        <div class="text-right">
            <p id="v-cash" class="text-lg font-black text-emerald-400">Rp 0</p>
        </div>
    </div>

    <div class="main-content">
        <div class="menu-side overflow-y-auto scroll-custom">
            <div class="p-2 border-b bg-white flex gap-2">
                <select id="cat-select" onchange="filterCat(this.value)" class="flex-1 p-2 bg-slate-100 border rounded-lg text-[10px] font-black uppercase">
                    <option value="ALL">SEMUA MENU</option>
                </select>
                <input type="text" id="menuSearch" oninput="renderMenu()" placeholder="Cari..." class="w-32 p-2 bg-slate-100 border rounded-lg text-[10px] font-bold">
            </div>
            <div id="menu-render" class="grid grid-cols-4 gap-2 p-3"></div>
        </div>

        <div class="admin-side">
            <div class="scroll-area space-y-3">
                <div onclick="toggleSwipe()" class="swipe-handle">ðŸ“‚ OPERASIONAL & MEMBER</div>
                
                <div id="collapsible-section" class="collapse-content space-y-3 p-2 bg-slate-100 rounded-xl border">
                    <div class="bg-blue-600 p-3 rounded-lg text-white shadow-md">
                        <p class="text-[9px] font-black uppercase mb-1">Loyalty Member</p>
                        <div class="flex gap-2">
                            <input type="number" id="member-hp" placeholder="Nomor HP..." class="flex-1 p-2 rounded text-xs font-bold text-slate-800 outline-none">
                            <button onclick="cekMember()" class="bg-yellow-400 text-slate-900 px-4 rounded font-black text-[10px] active:scale-95">CEK</button>
                        </div>
                        <div id="member-info" class="mt-2 hidden bg-blue-700 p-2 rounded border border-blue-500">
                            <p id="m-nama" class="text-[11px] font-black"></p>
                            <p id="m-poin" class="text-[10px] font-bold text-yellow-300"></p>
                            <button id="btn-redeem" onclick="applyRedeem()" class="mt-2 w-full bg-white text-blue-700 py-1.5 rounded font-black text-[9px] uppercase shadow-sm">Tukar Poin</button>
                        </div>
                    </div>

                    <div class="bg-white p-3 rounded-lg border shadow-sm">
                        <div id="shift-open-area" class="flex gap-2">
                            <input type="number" id="input-modal" placeholder="Modal Awal" class="flex-1 p-2 bg-slate-50 border rounded text-xs font-bold">
                            <button id="btn-buka-shift" onclick="bukaShift()" class="bg-emerald-600 text-white px-4 rounded font-black text-[9px]">BUKA</button>
                        </div>
                        <button id="btn-tutup-shift" onclick="tutupShift()" class="w-full mt-2 bg-red-600 text-white py-3 rounded font-black text-[10px] hidden shadow-lg uppercase">Tutup Shift & Settle</button>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-[8px] font-black">
                        <button onclick="saveFinance('pengeluaran', 'Pengeluaran')" class="bg-orange-500 text-white p-3 rounded uppercase shadow-sm active:scale-95">Pengeluaran</button>
                        <button onclick="saveFinance('online_food', 'Online Food')" class="bg-purple-500 text-white p-3 rounded uppercase shadow-sm active:scale-95">Online Food</button>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-2 border-2 border-slate-200 min-h-[180px]">
                    <p class="text-[9px] font-black text-slate-400 mb-2 uppercase text-center border-b pb-1">Daftar Pesanan</p>
                    <div id="cart-list" class="space-y-2"></div>
                </div>
            </div>

            <div class="sticky-bottom p-4 border-t-2">
                <div id="discount-area" class="hidden flex justify-between text-red-600 text-[11px] font-black mb-1 italic">
                    <span>REDEEM POIN:</span><span id="v-discount">-Rp 0</span>
                </div>
                <div class="flex justify-between text-[#1B4332] mb-2">
                    <span class="font-black text-[12px]">TOTAL</span>
                    <span id="v-total" class="text-3xl font-black">Rp 0</span>
                </div>
                <button onclick="submitOrder()" id="btn-order" class="w-full bg-[#1B4332] text-white py-4 rounded-2xl font-black text-[14px] shadow-lg active:scale-95 transition-all uppercase">Bayar & Cetak</button>
            </div>
        </div>
    </div>
</div>

<script>
const CONFIG={
    API:"https://script.google.com/macros/s/AKfycbwgE4TNuajMZy34ZOQKcHbUniCm6wU-a4rjGESFZC_1r6wUBVm_EwUZKvqchK-Pk6jL/exec",
    CSV:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv",
    TOKEN:"dyg-access-v2"
};

let cart={}, menuData=[], activeCat='ALL';
let memberData = null, discount = 0;

function toggleSwipe(){
    const s=document.getElementById("collapsible-section");
    s.style.display=s.style.display==="block"?"none":"block";
}

// --- LOGIKA MEMBER (SYARAT MINIMAL 5000 & KELIPATAN) ---
async function cekMember() {
    const hp = document.getElementById("member-hp").value;
    if(!hp) return alert("Masukkan Nomor HP!");
    try {
        const r = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=cekMember&noHP=${hp}`);
        const d = await r.json();
        if(d.exists) {
            memberData = d; memberData.noHP = hp;
            document.getElementById("m-nama").innerText = "Nama: " + d.nama;
            document.getElementById("m-poin").innerText = "Poin Tersedia: " + Number(d.poin).toLocaleString();
            document.getElementById("member-info").classList.remove("hidden");
            
            // Syarat minimal 5000 poin untuk redeem
            document.getElementById("btn-redeem").style.display = d.poin >= 5000 ? "block" : "none";
            document.getElementById("btn-redeem").innerText = `TUKAR ${Number(d.poin).toLocaleString()} POIN (Rp ${Number(d.poin).toLocaleString()})`;
        } else { alert("Member tidak terdaftar!"); }
    } catch(e) { alert("Koneksi Gagal!"); }
}

function applyRedeem() {
    // Redem kelipatan poin yang dimiliki (1 poin = 1 rupiah)
    discount = memberData.poin; 
    document.getElementById("discount-area").classList.remove("hidden");
    document.getElementById("v-discount").innerText = "-Rp " + discount.toLocaleString();
    updateCartUI();
}

// --- KERANJANG & MENU ---
function addToCart(n,p){
    cart[n]={price:p, qty:(cart[n]?.qty||0)+1};
    updateCartUI(); renderMenu();
}

function changeQty(n, d) {
    cart[n].qty += d;
    if(cart[n].qty <= 0) delete cart[n];
    updateCartUI(); renderMenu();
}

function updateCartUI(){
    let subtotal=0;
    const l=document.getElementById("cart-list");
    l.innerHTML="";
    Object.keys(cart).forEach(n=>{
        const sub = cart[n].price * cart[n].qty;
        subtotal += sub;
        l.innerHTML+=`
        <div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg border border-slate-100 shadow-sm">
            <div class="flex-1"><p class="text-[10px] font-black text-slate-700">${n}</p></div>
            <div class="flex items-center gap-2">
                <button onclick="changeQty('${n}',-1)" class="w-6 h-6 bg-slate-200 rounded flex items-center justify-center font-bold">-</button>
                <span class="text-[10px] font-black w-4 text-center">${cart[n].qty}</span>
                <button onclick="changeQty('${n}',1)" class="w-6 h-6 bg-slate-800 text-white rounded flex items-center justify-center font-bold">+</button>
            </div>
        </div>`;
    });
    document.getElementById("v-total").innerText="Rp "+ (Math.max(0, subtotal - discount)).toLocaleString();
}

// --- FINANCE ---
async function updateMonitor() {
    try {
        const r = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=getFinance`);
        const f = await r.json();
        window.finData = f;
        document.getElementById("v-cash").innerText = "Rp " + ((f.totalModal + f.totalCash) - f.totalOut).toLocaleString();
    } catch(e){}
}

async function submitOrder(){
    const subtotal = Object.values(cart).reduce((s,i)=>s+i.price*i.qty,0);
    const finalTotal = Math.max(0, subtotal - discount);
    if(subtotal <= 0) return alert("Pilih menu!");
    
    const btn = document.getElementById("btn-order");
    btn.innerText = "SEDANG MENCETAK..."; btn.disabled = true;

    try {
        const hp = memberData ? memberData.noHP : "";
        const poinRedeem = discount; // Kelipatan total poin yang ditukar
        
        // Kirim ke GAS (Logic update poin di GAS sudah pakem)
        await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=processOrder&total=${finalTotal}&noHP=${hp}&poinRedeem=${poinRedeem}&pesanan=${encodeURIComponent(JSON.stringify(cart))}&nama=${memberData?memberData.nama:'Umum'}`);

        // PRINT ESC/POS
        let esc = "\x1B\x40\x1B\x61\x01dyg++ POS SECURE\n--------------------------------\n";
        esc += new Date().toLocaleString() + "\n--------------------------------\n\x1B\x61\x00";
        Object.keys(cart).forEach(n => { esc += `${n} x${cart[n].qty}\n   Rp ${(cart[n].price*cart[n].qty).toLocaleString()}\n`; });
        if(discount > 0) esc += `REDEEM POIN: -Rp ${discount.toLocaleString()}\n`;
        esc += `--------------------------------\nTOTAL: Rp ${finalTotal.toLocaleString()}\n\nTERIMA KASIH\n\n\n\n\n`;

        if (window.AppInventor) { window.AppInventor.setWebViewString("PRINT|" + esc); }
        alert("Transaksi Berhasil!"); location.reload();
    } catch (e) { alert("Gagal Simpan!"); btn.disabled = false; }
}

// --- SISTEM SHIFT ---
async function bukaShift() {
    const val = document.getElementById("input-modal").value;
    if(!val || val <= 0) return alert("Isi Modal!");
    const d = JSON.stringify(["", "Modal Awal", val]);
    await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=saveFinance&type=modal&data=${encodeURIComponent(d)}`);
    document.getElementById("input-modal").disabled = true;
    document.getElementById("btn-buka-shift").style.display = "none";
    document.getElementById("btn-tutup-shift").classList.remove("hidden");
    updateMonitor();
}

async function tutupShift() {
    const f = window.finData;
    const sys = (f.totalModal + f.totalCash) - f.totalOut;
    const fisik = prompt("Masukkan Total Uang Fisik:", sys);
    if(fisik === null) return;
    const s = fisik - sys;
    const pay = JSON.stringify({ sys, fisik, selisih: s });
    await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=settle&data=${encodeURIComponent(pay)}`);
    
    let esc = "\x1B\x40\x1B\x61\x01LAPORAN CLOSING\n--------------------------------\n";
    esc += `MODAL: Rp ${f.totalModal.toLocaleString()}\nCASH : Rp ${f.totalCash.toLocaleString()}\nOUT  : Rp ${f.totalOut.toLocaleString()}\n`;
    esc += `FISIK: Rp ${Number(fisik).toLocaleString()}\nSELISIH: Rp ${s.toLocaleString()}\n\nSHIFT SELESAI\n\n\n\n\n`;
    if (window.AppInventor) { window.AppInventor.setWebViewString("PRINT|" + esc); }
    location.reload();
}

async function saveFinance(type, label) {
    const v = prompt("Nominal " + label + ":");
    if(!v || v <= 0) return;
    const d = JSON.stringify(["", label, v]);
    await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=saveFinance&type=${type}&data=${encodeURIComponent(d)}`);
    updateMonitor();
}

async function loadMenu(){
    const r=await fetch(CONFIG.CSV);
    const t=await r.text();
    menuData = t.split("\n").slice(1).map(r => {
        const c = r.split(",");
        return { kat: c[0]?.trim(), nama: c[1]?.trim(), harga: parseInt(c[2]) || 0 };
    }).filter(m => m.nama);
    renderMenu();
}

function renderMenu(){
    const c=document.getElementById("menu-render");
    const s=document.getElementById("menuSearch").value.toLowerCase();
    c.innerHTML="";
    menuData.filter(m => activeCat === 'ALL' || m.kat === activeCat).filter(m => m.nama.toLowerCase().includes(s)).forEach(m=>{
        const q = cart[m.nama]?.qty || 0;
        c.innerHTML+=`<div onclick="addToCart('${m.nama}',${m.harga})" class="relative bg-white p-3 rounded-xl shadow-sm border border-slate-200 active:scale-95 transition-all cursor-pointer">
            ${q>0?`<div class="badge-qty">${q}</div>`:''}
            <p class="text-[10px] font-black leading-tight h-8 overflow-hidden">${m.nama}</p>
            <p class="text-emerald-600 font-bold text-[9px] mt-1">Rp ${m.harga.toLocaleString()}</p>
        </div>`;
    });
}
function filterCat(v){ activeCat=v; renderMenu(); }
window.onload=()=>{ loadMenu(); updateMonitor(); }
</script>
</body>
</html>