<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>dyg++ POS FINAL</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
body{font-family:'Inter',sans-serif;background:#f1f5f9;overflow:hidden}
.custom-scroll::-webkit-scrollbar{width:4px}
.custom-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:10px}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:6px}
.menu-card{border:1px solid #e2e8f0}
.menu-card:active{transform:scale(.96)}
input,select{outline:none}
</style>
</head>

<body class="h-screen flex flex-col">

<header class="h-[52px] bg-white border-b px-4 flex justify-between items-center">
<h1 class="font-extrabold text-blue-700">CLOUDkitchen.dyg++</h1>
<div class="flex gap-2 items-center">
<span id="shiftAlert" class="text-[10px] text-red-600 font-bold hidden">SHIFT TUTUP</span>
<button id="btnOpenShift" onclick="manageShift('open')" class="bg-emerald-600 text-white px-2 py-1 rounded text-[10px]">BUKA</button>
<button id="btnCloseShift" onclick="manageShift('close')" class="bg-rose-600 text-white px-2 py-1 rounded text-[10px] hidden">TUTUP</button>
</div>
</header>

<main class="flex flex-1 overflow-hidden">

<!-- MENU -->
<section class="flex-1 flex flex-col bg-slate-50">
<div class="p-2 bg-white border-b flex gap-2">
<input id="searchInput" oninput="renderMenu()" placeholder="Cari menu..."
class="flex-1 bg-slate-100 rounded px-2 text-xs">
<select id="categoryFilter" onchange="renderMenu()"
class="bg-slate-100 rounded px-2 text-xs font-bold">
<option value="ALL">SEMUA</option>
</select>
</div>
<div id="menuList" class="menu-grid p-2 overflow-y-auto custom-scroll"></div>
</section>

<!-- KERANJANG -->
<section class="w-[340px] bg-white border-l flex flex-col">
<div class="p-2 border-b font-bold text-xs">KERANJANG</div>

<div id="cartList"
class="flex-1 p-2 overflow-y-auto custom-scroll text-xs text-slate-400 text-center">
Kosong
</div>

<!-- MEMBER -->
<div class="p-2 border-t space-y-1 text-xs">
<input id="memberInput" placeholder="No WA / ID Member"
class="w-full bg-slate-100 rounded px-2 py-1">
<div class="text-[10px] text-slate-500">
Poin tersedia: <span id="memberPoint">0</span>
</div>
</div>

<!-- DISKON -->
<div class="p-2 border-t space-y-2 text-xs">
<input id="pointInput" type="number" min="0"
placeholder="Redeem poin (min 500, kelipatan 500)"
class="w-full bg-slate-100 rounded px-2 py-1">

<button onclick="applyPoint()"
class="w-full bg-slate-700 text-white py-1 rounded font-bold">
Gunakan Poin
</button>

<div class="flex justify-between font-bold">
<span>SUBTOTAL</span>
<span>Rp <span id="subTotal">0</span></span>
</div>
<div class="flex justify-between text-emerald-600 font-bold">
<span>POTONGAN</span>
<span>- Rp <span id="discount">0</span></span>
</div>
<div class="flex justify-between font-black">
<span>TOTAL</span>
<span>Rp <span id="total">0</span></span>
</div>
</div>

<!-- PEMBAYARAN -->
<div class="p-2 border-t text-xs space-y-2">
<input id="cashInput" type="number"
placeholder="Uang diterima"
oninput="calcChange()"
class="w-full bg-slate-100 rounded px-2 py-1">

<div class="flex justify-between font-bold">
<span>KEMBALI</span>
<span>Rp <span id="change">0</span></span>
</div>

<button id="btnSubmit" onclick="submitOrder()"
class="w-full bg-blue-600 text-white py-2 rounded font-bold">
Bayar & Cetak
</button>
</div>

</section>
</main>

<script>
/* ================= CONFIG ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbwTo5_KeeT_HN7T1zMJG8EEQV1B4GoUic3he6eFQtUk4KAR3NSMb0Ml9x2IvBJ7_TEnIA/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQZGCGtu4xfKCj0zCGB2BldzF2fLjFCIOfVSXBAMeTM-3KGHfC9mZ_bhfaTnikwxd5427w4ULtotTJH/pub?gid=2132421401&single=true&output=csv";
const TOKEN = "dyg-access-v2";

/* ================= STATE ================= */
let MENU = [], cart = {}, shiftOpen = false, printing = false;
let pointDiscount = 0;
let pendingOrder = null;

/* ================= SHIFT ================= */
async function checkShift(){
  const r = await fetch(`${API_URL}?token=${TOKEN}&action=getShiftStatus`);
  shiftOpen = (await r.text()) === "OPEN";
  btnOpenShift.classList.toggle("hidden", shiftOpen);
  btnCloseShift.classList.toggle("hidden", !shiftOpen);
  shiftAlert.classList.toggle("hidden", shiftOpen);
  btnSubmit.disabled = !shiftOpen;
}

async function manageShift(type){
  const action = type === 'open' ? 'openShift' : 'closeShift';
  if(!confirm(type === 'open' ? "Buka shift?" : "Tutup shift?")) return;
  await fetch(`${API_URL}?token=${TOKEN}&action=${action}`, {mode:'no-cors'});
  location.reload();
}

/* ================= MENU ================= */
async function loadMenu(){
  const t = await fetch(CSV_URL).then(r=>r.text());
  const rows = t.trim().split("\n").slice(1);
  MENU = rows.map(r=>{
    const c = r.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/);
    return {kategori:c[0], nama:c[1], harga:Number(c[2])||0};
  });
categoryFilter.innerHTML = '<option value="ALL">SEMUA</option>';
[...new Set(MENU.map(m=>m.kategori))].forEach(k=>{
     categoryFilter.innerHTML += `<option>${k}</option>`;
  });
  renderMenu();
}

function renderMenu(){
  menuList.innerHTML="";
  const q = searchInput.value.toLowerCase();
  const f = categoryFilter.value;
  MENU.forEach((m,i)=>{
    if((f==="ALL"||m.kategori===f)&&m.nama.toLowerCase().includes(q)){
      menuList.innerHTML+=`
      <div class="menu-card bg-white p-2 rounded cursor-pointer" onclick="addItem(${i})">
        <div class="text-[9px] text-blue-600 font-bold">${m.kategori}</div>
        <div class="font-bold text-xs">${m.nama}</div>
        <div class="font-black text-xs">Rp ${m.harga.toLocaleString()}</div>
      </div>`;
    }
  });
}

/* ================= CART ================= */
function addItem(i){
  cart[i]=(cart[i]||{...MENU[i],qty:0});
  cart[i].qty++;
  renderCart();
}

function renderCart(){
  let sub=0, html="";
  Object.values(cart).forEach(i=>{
    sub+=i.qty*i.harga;
    html+=`<div class="flex justify-between">
      <span>${i.nama} x${i.qty}</span>
      <span>${(i.qty*i.harga).toLocaleString()}</span>
    </div>`;
  });
  cartList.innerHTML = html || "Kosong";
  subTotal.textContent = sub.toLocaleString();
  recalcTotal();
}

/* ================= POIN ================= */
function applyPoint(){
  pointDiscount = 0;
  const sub = parseInt(subTotal.textContent.replace(/\D/g,""))||0;
  let p = Number(pointInput.value)||0;
  if(p < 500){ alert("Minimal 500 poin"); return; }
  const valid = Math.floor(p/500)*500;
  const value = valid * 100;
  if(value >= sub){ alert("Poin melebihi subtotal"); return; }
  pointDiscount = value;
  pointInput.value = valid;
  discount.textContent = value.toLocaleString();
  recalcTotal();
}

function recalcTotal(){
  const sub = parseInt(subTotal.textContent.replace(/\D/g,""))||0;
  total.textContent = Math.max(sub-pointDiscount,0).toLocaleString();
  calcChange();
}

function calcChange(){
  const cash = Number(cashInput.value)||0;
  const t = parseInt(total.textContent.replace(/\D/g,""))||0;
  change.textContent = Math.max(cash-t,0).toLocaleString();
}

/* ================= SUBMIT & CLOUD ================= */
function submitOrder(){
  if(!shiftOpen||printing) return;
  if(!Object.keys(cart).length) return alert("Keranjang kosong");

  printing=true;
  btnSubmit.textContent="MENCETAK...";
  btnSubmit.disabled=true;

  const totalBayar = parseInt(total.textContent.replace(/\D/g,""))||0;
  const sub = parseInt(subTotal.textContent.replace(/\D/g,""))||0;
  const pesanan = Object.values(cart).map(i=>`${i.nama} x${i.qty}`).join(", ");

  pendingOrder = {
    total: totalBayar,
    pesanan,
    metode:"CASH",
    trxId:"TRX-"+Date.now(),
    noWA: memberInput.value||"-"
  };

  const earn = Math.floor(totalBayar/20000)*100;

  const esc =
    "\x1B\x40\x1B\x61\x01dyg++ CLOUD KITCHEN\n" +
    "------------------------------\n\x1B\x61\x00" +
    pesanan.replace(/, /g,"\n")+"\n" +
    "SUBTOTAL: Rp "+sub+"\n" +
    "POTONGAN: Rp "+pointDiscount+"\n" +
    "TOTAL   : Rp "+totalBayar+"\n" +
    "POIN +  : "+earn+"\n\n";

  if(window.AppInventor){
    window.AppInventor.setWebViewString("PRINT|"+esc);
    setTimeout(prosesSimpanKeCloud,1500);
  }else{
    console.log(esc);
    prosesSimpanKeCloud();
  }
}

async function prosesSimpanKeCloud(){
  const rQty = pointDiscount/100;
  const p = new URLSearchParams({
    token:TOKEN,
    action:"processPayment",
    total:pendingOrder.total,
    pesanan:pendingOrder.pesanan,
    method:pendingOrder.metode,
    trxId:pendingOrder.trxId,
    noWA:pendingOrder.noWA,
    redeemQty:rQty
  });
  await fetch(`${API_URL}?${p.toString()}`,{mode:'no-cors'});
  alert("✅ Transaksi tercatat");
  location.reload();
}

/* ================= INIT ================= */
window.onload=()=>{loadMenu();checkShift();}
</script>

</body>
</html>
