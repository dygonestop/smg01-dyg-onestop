<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OWNER INTELLIGENCE | dyg++</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0b0f1a; color: #f8fafc; }
        .glass-card { background: rgba(17, 24, 39, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); transition: all 0.3s ease; }
        .glass-card:hover { border-color: rgba(16, 185, 129, 0.3); transform: translateY(-2px); }
        .trend-up { color: #10b981; }
        .trend-down { color: #f43f5e; }
        .bg-glow-emerald { shadow-lg shadow-emerald-500/20; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #0b0f1a; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-6 lg:px-12 mb-12">

    <header class="flex flex-col md:flex-row justify-between items-end mb-8 gap-6">
        <div>
            <div class="flex items-center gap-2 mb-1">
                <div class="h-3 w-3 bg-emerald-500 rounded-full animate-pulse"></div>
                <h1 class="text-3xl font-black text-white tracking-tighter uppercase">Dyg++ <span class="text-emerald-500">Intelligence</span></h1>
            </div>
            <p class="text-slate-400 text-sm font-medium">Monitoring Bisnis & Advisor Otomatis</p>
        </div>
        <div class="flex flex-col items-end">
            <button onclick="refreshData()" id="btn-refresh" class="group flex items-center gap-2 px-6 py-3 bg-emerald-600 hover:bg-emerald-500 rounded-2xl text-xs font-black transition-all shadow-xl shadow-emerald-900/20 active:scale-95">
                <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                REFRESH INSIGHTS
            </button>
            <p id="last-update" class="text-[9px] font-mono text-slate-500 mt-2 tracking-widest uppercase text-right">System Standby</p>
        </div>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="glass-card p-6 rounded-[2.5rem] border-b-4 border-emerald-500 relative overflow-hidden">
            <div class="flex justify-between items-start mb-4">
                <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Omzet Hari Ini</p>
                <div id="growth-badge" class="px-2 py-1 rounded-lg bg-slate-800 text-[10px] font-black">--</div>
            </div>
            <h3 id="rev-day" class="text-4xl font-black text-white mb-1 tracking-tight">Rp 0</h3>
            <p id="rev-yesterday" class="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">Vs Kemarin: Rp 0</p>
        </div>

        <div class="glass-card p-6 rounded-[2.5rem] border-b-4 border-blue-500">
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-4">Omzet Bulan Ini</p>
            <h3 id="rev-month" class="text-4xl font-black text-white mb-1 tracking-tight">Rp 0</h3>
            <div class="flex items-center gap-2 mt-2 text-[10px] text-slate-400">
                <span class="font-bold">Target: 30jt</span>
                <div class="flex-1 h-1 bg-slate-800 rounded-full overflow-hidden">
                    <div id="target-progress" class="bg-blue-500 h-full transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <div class="glass-card p-6 rounded-[2.5rem] border-b-4 border-purple-500 bg-gradient-to-br from-slate-900/50 to-purple-900/10">
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest mb-4">Estimasi Profit</p>
            <h3 id="est-profit" class="text-4xl font-black text-purple-400 mb-1 tracking-tight">Rp 0</h3>
            <p class="text-[10px] text-slate-500 font-bold uppercase italic">Sudah Potong Belanja</p>
        </div>

        <div class="glass-card p-6 rounded-[2.5rem] border-b-4 border-red-500">
            <div class="flex justify-between items-center mb-4">
                <p class="text-slate-400 text-[10px] font-black uppercase tracking-widest">Total Belanja</p>
                <span id="exp-ratio" class="text-[10px] font-black px-2 py-1 rounded-lg bg-red-500/10 text-red-500">0%</span>
            </div>
            <h3 id="exp-day" class="text-4xl font-black text-red-400 mb-1 tracking-tight">Rp 0</h3>
            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-tighter">Operasional Hari Ini</p>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <div class="lg:col-span-2 glass-card p-8 rounded-[3rem]">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h4 class="font-black text-xl tracking-tight text-white uppercase">Trafik <span class="text-emerald-500">Real-time</span></h4>
                    <p class="text-slate-500 text-xs">Pantauan sebaran transaksi per jam</p>
                </div>
                <div class="flex gap-2">
                    <div class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span class="text-[10px] text-slate-400 font-black uppercase tracking-widest">Live Flow</span>
                </div>
            </div>
            <div class="h-[320px]">
                <canvas id="hourChart"></canvas>
            </div>
        </div>

        <div class="glass-card p-8 rounded-[3rem] bg-gradient-to-br from-slate-900 to-slate-950 border-t-8 border-emerald-500/20">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-3 bg-emerald-500/20 rounded-2xl text-emerald-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <h4 class="font-black text-lg text-white">AI ADVISOR</h4>
                    <p class="text-[10px] text-slate-500 uppercase font-black tracking-widest">Saran Perbaikan</p>
                </div>
            </div>
            
            <div id="ai-advice" class="space-y-4">
                <div class="animate-pulse flex space-x-4">
                    <div class="flex-1 space-y-4 py-1">
                        <div class="h-4 bg-slate-800 rounded w-3/4"></div>
                        <div class="h-10 bg-slate-800 rounded"></div>
                    </div>
                </div>
            </div>

            <div class="mt-8 p-4 bg-emerald-500/5 rounded-2xl border border-emerald-500/10">
                <p class="text-[10px] font-black text-emerald-500 uppercase mb-2 tracking-widest">Saran Jam Sibuk</p>
                <p id="peak-recommendation" class="text-xs text-slate-400 leading-relaxed italic">Menganalisa data...</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
        <div class="glass-card p-8 rounded-[2.5rem]">
            <h4 class="text-xs font-black text-slate-500 uppercase mb-6 tracking-widest flex items-center gap-2">
                <span class="w-2 h-4 bg-emerald-500 rounded-full"></span> Produk Terlaris
            </h4>
            <div id="top-items" class="space-y-5"></div>
        </div>

        <div class="glass-card p-8 rounded-[2.5rem]">
            <h4 class="text-xs font-black text-slate-500 uppercase mb-6 tracking-widest flex items-center gap-2">
                <span class="w-2 h-4 bg-blue-500 rounded-full"></span> Performance Meja
            </h4>
            <div id="table-performance" class="space-y-4"></div>
        </div>

        <div class="glass-card p-8 rounded-[2.5rem]">
            <h4 class="text-xs font-black text-slate-500 uppercase mb-6 tracking-widest">Metode Bayar</h4>
            <div class="h-48 relative mb-4">
                <canvas id="payChart"></canvas>
            </div>
            <div id="pay-detail" class="flex justify-between gap-4"></div>
        </div>
    </div>

    <script>
        const CONFIG = {
            API: "https://script.google.com/macros/s/AKfycbyovjLd6dlJehqyX4t5y1JTyHLjJo_aFeMNLsLmHkJauZL41ZSxLuC7V9eNFfi87Nt4pg/exec",
            TOKEN: "dyg-access-v2"
        };

        let charts = {};

        async function refreshData() {
            const btn = document.getElementById('btn-refresh');
            const icon = document.getElementById('refresh-icon');
            
            btn.classList.add('opacity-50');
            icon.classList.add('rotate-180');
            document.getElementById('last-update').innerText = "SYNCHRONIZING...";

            try {
                // Sesuai dengan action di backend baru kita
                const resp = await fetch(`${CONFIG.API}?token=${CONFIG.TOKEN}&action=getDashboardData`);
                const data = await resp.json();
                updateUI(data);
                document.getElementById('last-update').innerText = "LAST SYNC: " + new Date().toLocaleTimeString();
            } catch (e) {
                console.error(e);
                document.getElementById('last-update').innerText = "OFFLINE - RECHECKING";
            } finally {
                btn.classList.remove('opacity-50');
                icon.classList.remove('rotate-180');
            }
        }

        function updateUI(data) {
            // 1. Stats Utama & Growth
            document.getElementById('rev-day').innerText = formatIDR(data.income.day);
            document.getElementById('rev-yesterday').innerText = "VS KEMARIN: " + formatIDR(data.income.yesterday);
            document.getElementById('rev-month').innerText = formatIDR(data.income.month);
            
            const growthBadge = document.getElementById('growth-badge');
            const growthVal = data.income.growth.toFixed(1);
            if(growthVal >= 0) {
                growthBadge.innerHTML = `▲ ${growthVal}%`;
                growthBadge.className = "px-2 py-1 rounded-lg bg-emerald-500/20 text-emerald-400 text-[10px] font-black";
            } else {
                growthBadge.innerHTML = `▼ ${Math.abs(growthVal)}%`;
                growthBadge.className = "px-2 py-1 rounded-lg bg-red-500/20 text-red-400 text-[10px] font-black";
            }

            // 2. Profit & Expense
            const profit = data.income.day - data.expense.day;
            document.getElementById('est-profit').innerText = formatIDR(profit);
            document.getElementById('exp-day').innerText = formatIDR(data.expense.day);
            
            const ratio = ((data.expense.day / data.income.day) * 100).toFixed(0);
            document.getElementById('exp-ratio').innerText = ratio + "%";

            // 3. Progress Target (Misal Target 30 Juta Sebulan)
            const targetMonth = 30000000;
            const progress = Math.min((data.income.month / targetMonth) * 100, 100);
            document.getElementById('target-progress').style.width = progress + "%";

            // 4. AI Recommendation
            document.getElementById('ai-advice').innerHTML = `
                <div class="p-5 bg-emerald-500/10 rounded-[2rem] border-l-4 border-emerald-500">
                    <p class="text-xs text-white font-bold leading-relaxed">${data.recommendation}</p>
                </div>
            `;

            // 5. Charts
            updateCharts(data);
            renderLists(data);
        }

        function updateCharts(data) {
            // Hour Chart (Line)
            const ctxH = document.getElementById('hourChart').getContext('2d');
            if(charts.hour) charts.hour.destroy();
            charts.hour = new Chart(ctxH, {
                type: 'line',
                data: {
                    labels: data.peakHours.labels,
                    datasets: [{
                        label: 'Omzet',
                        data: data.peakHours.values,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 5,
                        pointRadius: 4,
                        pointBackgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { ticks: { color: '#64748b', font: { size: 10, weight: 'bold' } }, grid: { display: false } }
                    }
                }
            });

            // Cari Peak Hour tertinggi untuk saran
            const maxVal = Math.max(...data.peakHours.values);
            const peakIdx = data.peakHours.values.indexOf(maxVal);
            document.getElementById('peak-recommendation').innerText = `Performa puncak hari ini di jam ${data.peakHours.labels[peakIdx]}. Rekomendasi: Pastikan kru standby 30 menit sebelum jam ini.`;
        }

        function renderLists(data) {
            // Top Items
            const itemHTML = data.topItems.map((item, i) => `
                <div class="flex justify-between items-center group">
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-black text-slate-700">${i+1}</span>
                        <span class="text-xs font-bold text-slate-300 group-hover:text-emerald-400 transition-colors uppercase tracking-tight">${item.nama}</span>
                    </div>
                    <span class="text-[10px] font-black bg-slate-800 px-3 py-1 rounded-lg text-slate-400">${item.qty} Porsi</span>
                </div>
            `).join('');
            document.getElementById('top-items').innerHTML = itemHTML || '<p class="text-xs text-slate-600">Belum ada order hari ini</p>';
        }

        function formatIDR(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
        }

        // Auto Refresh tiap 5 menit
        refreshData();
        setInterval(refreshData, 300000);
    </script>
</body>
</html>