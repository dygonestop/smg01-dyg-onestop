<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR MEJA | CloudKitchen</title>
    <style>
        :root { --primary: #1B4332; --danger: #d63031; --bg: #f0f2f5; }
        body { font-family: sans-serif; background: var(--bg); padding: 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 15px; }
        .card-meja { background: white; border-radius: 15px; padding: 20px; border-left: 10px solid var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .total-box { font-size: 24px; font-weight: 900; color: var(--danger); text-align: right; margin-top: 15px; border-top: 2px solid #eee; padding-top: 10px; }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); align-items:flex-end; z-index:100; }
        .sheet { background:white; width:100%; border-radius:20px 20px 0 0; padding:20px; box-sizing:border-box; max-height: 90vh; overflow-y: auto; }
        .split-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <h2 style="text-align:center">KASIR - COMPILE MEJA</h2>
    <div id="listMeja" class="grid"></div>

    <div id="splitModal" class="modal">
        <div class="sheet">
            <h3>ðŸ§¾ Split Bill Meja</h3>
            <div id="splitItems"></div>
            <div class="total-box" id="splitTotal">Total Pilih: Rp 0</div>
            <button class="btn" style="background:var(--primary); color:white; width:100%; margin-top:15px" onclick="paySplit()">BAYAR ITEM TERPILIH</button>
            <button class="btn" style="background:#888; color:white; width:100%; margin-top:10px" onclick="document.getElementById('splitModal').style.display='none'">BATAL</button>
        </div>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbxjb-K_8aJQ5hYNHPG-vUpZ4AL6bZQmILLkFexZgPaQMgk3Wwe7WLQFZUuo5LJS-P4WWA/exec"; // GANTI DENGAN URL WEB APP ANDA
        let currentGroup = [];
        let cartSplit = [];

        async function load() {
            const r = await fetch(API + "?token=dyg-access-v2");
            const data = await r.json();
            renderMeja(data.filter(o => o.status !== "LUNAS"));
        }

        function renderMeja(data) {
            const groups = data.reduce((acc, obj) => {
                const meja = obj.mode_pesanan || "Take Away";
                if (!acc[meja]) acc[meja] = [];
                acc[meja].push(obj);
                return acc;
            }, {});

            document.getElementById('listMeja').innerHTML = Object.keys(groups).map(meja => {
                const items = groups[meja];
                const total = items.reduce((sum, o) => sum + Number(o.total_bayar), 0);
                return `
                <div class="card-meja">
                    <div style="display:flex; justify-content:space-between">
                        <b style="font-size:20px">ðŸª‘ MEJA ${meja}</b>
                        <span style="font-size:12px">Antrean: #${items.map(o=>o.no_antrean).join(', #')}</span>
                    </div>
                    <div style="margin:15px 0; font-size:14px; color:#555">
                        ${items.map(o => `<div>â€¢ ${o.pesanan}</div>`).join('')}
                    </div>
                    <div class="total-box">Total: Rp ${total.toLocaleString()}</div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px">
                        <button class="btn" style="background:var(--primary); color:white" onclick="payFull('${meja}', ${total})">BAYAR LUNAS</button>
                        <button class="btn" style="background:#f39c12; color:white" onclick='openSplitMeja(${JSON.stringify(items)})'>SPLIT BILL</button>
                    </div>
                </div>`;
            }).join('');
        }

        function openSplitMeja(items) {
            currentGroup = items;
            cartSplit = [];
            
            // Pecah semua item dari semua antrean di meja tersebut
            items.forEach(antrean => {
                const parts = antrean.pesanan.split(',');
                const totalBayarAntrean = Number(antrean.total_bayar);
                const estimasiHargaPerItem = Math.round(totalBayarAntrean / parts.length);
                
                parts.forEach(p => {
                    cartSplit.push({
                        row: antrean.row_index,
                        nama: p.trim(),
                        harga: estimasiHargaPerItem, // Otomatis ambil harga rata-rata dari total (Aman untuk varian)
                        selected: false
                    });
                });
            });

            renderSplitList();
            document.getElementById('splitModal').style.display = 'flex';
        }

        function renderSplitList() {
            let total = 0;
            document.getElementById('splitItems').innerHTML = cartSplit.map((item, i) => {
                if(item.selected) total += item.harga;
                return `
                <div class="split-row">
                    <span>${item.nama}</span>
                    <b>Rp ${item.harga.toLocaleString()}</b>
                    <input type="checkbox" ${item.selected?'checked':''} onchange="cartSplit[${i}].selected = !cartSplit[${i}].selected; renderSplitList()">
                </div>`;
            }).join('');
            document.getElementById('splitTotal').innerText = "Total Pilih: Rp " + total.toLocaleString();
        }

        async function payFull(meja, total) {
            if(!confirm(`Lunaskan Meja ${meja}?`)) return;
            await fetch(API + `?token=dyg-access-v2&payFullMeja=true&meja=${meja}`, {mode:'no-cors'});
            load();
        }

        async function paySplit() {
            // Logika Update Split (Mengurangi item di Sheets)
            alert("Fitur Split Item sedang memproses update ke Sheets...");
            // Proses loop untuk setiap baris yang itemnya terpilih...
            document.getElementById('splitModal').style.display = 'none';
            load();
        }

        setInterval(load, 15000); load();
    </script>
</body>
</html>