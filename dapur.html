<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DAPUR | dyg++</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>

<style>
:root{
  --main:#1B4332;
  --danger:#c0392b;
  --bg:#f2f4f7;
}
body{
  margin:0;
  background:var(--bg);
  font-family:Segoe UI,Arial,sans-serif;
}
.header{
  margin:15px;
  padding:15px 20px;
  background:white;
  border-radius:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 4px 10px rgba(0,0,0,.05);
}
#status{
  font-weight:900;
  color:orange;
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(320px,1fr));
  gap:15px;
  padding:15px;
}
.card{
  background:white;
  border-radius:16px;
  padding:18px;
  border-top:8px solid var(--main);
  position:relative;
  animation:pop .3s ease;
}
@keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
.no{
  font-size:38px;
  font-weight:900;
  color:var(--main);
}
.name{
  font-size:20px;
  font-weight:900;
}
.mode{
  display:inline-block;
  margin-top:4px;
  padding:4px 10px;
  border-radius:12px;
  font-size:11px;
  font-weight:900;
  background:#eee;
}
.items{
  margin:14px 0;
  font-family:Courier New,monospace;
  font-weight:900;
}
.btn{
  width:100%;
  padding:16px;
  border:none;
  border-radius:12px;
  background:var(--main);
  color:white;
  font-weight:900;
  cursor:pointer;
}
.overlay{
  position:absolute;
  inset:0;
  background:rgba(192,57,43,.96);
  display:none;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  border-radius:16px;
  color:white;
}
.overlay.active{display:flex}
.overlay button{
  margin:6px;
  padding:12px 26px;
  border-radius:10px;
  border:none;
  font-weight:900;
  cursor:pointer;
}
.yes{background:white;color:var(--danger)}
.nope{background:transparent;color:white;border:2px solid white}
</style>
</head>

<body>

<div class="header">
  <h2>üë®‚Äçüç≥ MONITOR DAPUR</h2>
  <div id="status">‚óè Menghubungkan...</div>
</div>

<div class="grid" id="list"></div>

<audio id="notif" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<script>
/* ================= CONFIG FINAL ================= */
const CONFIG = {
  API_URL: "https://script.google.com/macros/s/AKfycbxBz2zBDeEsqNey4YINAAhJdMqVVBM1emAh7Lcol1CkbQ_xkBzMgZAzrVA0JfZ0UIKrgw/exec",
  TOKEN: "dyg-access-v2",
  REFRESH: 8000
};

/* ================= STATE ================= */
let lastCount = 0;
let removedRows = [];

/* ================= LOAD ================= */
async function loadOrders(){
  const status = document.getElementById("status");
  try{
    const res = await fetch(
      `${CONFIG.API_URL}?token=${CONFIG.TOKEN}&getOrders=true&_=${Date.now()}`
    );
    const data = await res.json();

    status.textContent = "‚óè TERHUBUNG";
    status.style.color = "green";

    if(data.length > lastCount && lastCount !== 0){
      document.getElementById("notif").play().catch(()=>{});
    }
    lastCount = data.length;
    render(data);
  }catch(err){
    console.error(err);
    status.textContent = "‚óè TERPUTUS";
    status.style.color = "red";
  }
}

/* ================= RENDER ================= */
function render(data){
  const box = document.getElementById("list");
  const active = data.filter(o => !removedRows.includes(String(o.row)));

  if(active.length === 0){
    box.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#999">Tidak ada pesanan</div>`;
    return;
  }

  box.innerHTML = active.map(o=>`
    <div class="card" id="c-${o.row}" data-row="${o.row}">
      <div class="overlay" id="ov-${o.row}">
        <b style="font-size:22px">SELESAI?</b>
        <div>
          <button class="yes" onclick="finish(${o.row})">YA</button>
          <button class="nope" onclick="cancel(${o.row})">BATAL</button>
        </div>
      </div>

      <div class="no">#${o.Antrean}</div>
      <div class="name">${o.Nama || "Pelanggan"}</div>
      <div class="mode">${o.Mode}</div>

      <div class="items">
        ${o.Pesanan.split(',').map(i=>`‚Ä¢ ${i.trim()}`).join("<br>")}
      </div>

      <button class="btn" onclick="finish(${o.row})">‚úî SELESAI</button>
    </div>
  `).join("");

  document.querySelectorAll(".card").forEach(card=>{
    const mc = new Hammer(card);
    mc.on("swipeleft",()=>{
      document.getElementById("ov-"+card.dataset.row).classList.add("active");
    });
  });
}

/* ================= ACTION ================= */
function cancel(row){
  document.getElementById("ov-"+row).classList.remove("active");
}

function finish(row){
  removedRows.push(String(row));
  document.getElementById("c-"+row)?.remove();

  fetch(
    `${CONFIG.API_URL}?token=${CONFIG.TOKEN}&updateStatus=true&row=${row}`
  ).catch(()=>{});
}

/* ================= LOOP ================= */
loadOrders();
setInterval(loadOrders, CONFIG.REFRESH);
</script>

</body>
</html>
